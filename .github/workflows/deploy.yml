name: ğŸš€ Deploy to Render

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  prepare-and-deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      actions: read
      checks: read
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: ğŸ”§ Prepare files for Render
      run: |
        echo "ğŸ“ Preparando arquivos para Render..."
        echo "ğŸ“‹ Estrutura atual:"
        ls -la
        
        # Copiar arquivos do backend para raiz
        echo "ğŸ“¦ Copiando arquivos do backend para raiz..."
        cp backend/app.py ./
        cp backend/requirements.txt ./
        
        # Copiar risk_model.pkl se existir
        if [ -f "backend/risk_model.pkl" ]; then
          cp backend/risk_model.pkl ./
          echo "âœ… risk_model.pkl copiado"
        else
          echo "âš ï¸ risk_model.pkl nÃ£o encontrado, continuando..."
        fi
        
        # âœ… APENAS VERIFICAR se runtime.txt existe (nÃ£o criar)
        if [ -f "runtime.txt" ]; then
          echo "âœ… runtime.txt jÃ¡ existe - mantido"
          cat runtime.txt
        else
          echo "â„¹ï¸ runtime.txt nÃ£o encontrado, usando padrÃ£o do Render"
        fi
        
        # Listar arquivos na raiz para verificaÃ§Ã£o
        echo "ğŸ“‹ Estrutura apÃ³s preparaÃ§Ã£o:"
        ls -la
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: âœ… Test application
      run: |
        echo "ğŸ§ª Testando se o app inicia..."
        python -c "
        try:
            from app import app
            print('âœ… App importado com sucesso!')
            print('âœ… Todas as rotas carregadas:')
            for route in app.routes:
                print(f'  - {route.path}')
        except Exception as e:
            print(f'âŒ Erro ao importar app: {e}')
            exit(1)
        "
        
    - name: ğŸ’¾ Commit deployment files
      run: |
        git config --local user.email "actions@github.com"
        git config --local user.name "GitHub Actions"
        
        # Verificar se hÃ¡ mudanÃ§as
        git status
        
        # Adicionar apenas os arquivos de deploy
        git add app.py requirements.txt
        
        # Adicionar risk_model.pkl se foi copiado
        if [ -f "risk_model.pkl" ]; then
          git add risk_model.pkl
        fi
        
        # âœ… CORREÃ‡ÃƒO: Adicionar runtime.txt se ele JÃ EXISTIR
        if [ -f "runtime.txt" ]; then
          git add runtime.txt
          echo "âœ… runtime.txt adicionado ao commit"
        fi
        
        # Fazer commit apenas se houver mudanÃ§as
        if git diff --staged --quiet; then
          echo "âš ï¸ Nenhuma mudanÃ§a para commit"
        else
          git commit -m "ğŸ¤– Auto-deploy: Copied backend files to root for Render [skip ci]"
          git push origin HEAD:master
          echo "âœ… MudanÃ§as commitadas e enviadas"
        fi
        
    - name: ğŸ‰ Deploy Ready
      run: |
        echo "ğŸ‰ PreparaÃ§Ã£o para Render concluÃ­da!"
        echo "ğŸ“ Arquivos na raiz prontos para deploy:"
        ls -la
        echo ""
        echo "ğŸš€ O Render farÃ¡ deploy automaticamente!"